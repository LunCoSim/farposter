<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌙 Farpost</title>
    
    <!-- Open Graph and Farcaster Frame Meta Tags -->
    <meta property="og:title" content="🌙 Farpost - Lunar Mining Game">
    <meta property="og:description" content="Extract resources from the Moon's surface and build your lunar empire! Deploy expeditions, collect resources, and expand your territory.">
    <meta property="og:image" content="https://farpost.lunco.space/api/frame-image?level=1&points=1000&cells=3&extracting=0&ready=0">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://farpost.lunco.space/">
    
    <!-- Farcaster Frame Meta Tags -->
    <meta property="fc:frame" content="vNext">
    <meta property="fc:frame:image" content="https://farpost.lunco.space/api/frame-image?level=1&points=1000&cells=3&extracting=0&ready=0">
    <meta property="fc:frame:button:1" content="🎮 Start Playing">
    <meta property="fc:frame:button:2" content="📖 How to Play">
    <meta property="fc:frame:button:2:action" content="link">
    <meta property="fc:frame:button:2:target" content="https://farpost.lunco.space/#tutorial">
    <meta property="fc:frame:button:3" content="🌐 Open Game">
    <meta property="fc:frame:button:3:action" content="link">
    <meta property="fc:frame:button:3:target" content="https://farpost.lunco.space/">
    <meta property="fc:frame:post_url" content="https://farpost.lunco.space/api/frame">
    <meta property="fc:frame:input:text" content="Enter your username (optional)">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            flex-wrap: wrap;
            gap: 10px;
        }

        .player-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .stat-label {
            font-size: 12px;
            color: #aaa;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
        }

        .game-title h1 {
            font-size: 20px;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .reset-btn {
            margin-top: 5px;
            padding: 6px 12px;
            background: #ff4444;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.3s;
        }

        .reset-btn:hover {
            background: #ff6666;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            padding: 20px;
            min-height: calc(100vh - 140px);
        }

        /* Map Container */
        .map-container {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #444;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .map-title {
            font-size: 20px;
            font-weight: bold;
        }

        .cell-info {
            font-size: 14px;
            color: #aaa;
        }

        /* Hexagonal Grid */
        .hex-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            justify-items: center;
            margin: 20px 0;
        }

        .hex-cell {
            width: 60px;
            height: 52px;
            background: #3a3a3a;
            border: 2px solid #555;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 10px;
            text-align: center;
            font-weight: bold;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .hex-cell:hover {
            background: #4a4a4a;
            border-color: #666;
            transform: scale(1.05);
        }

        .hex-cell.owned {
            background: #2a4a2a;
            border-color: #4CAF50;
        }

        .hex-cell.extracting {
            background: #4a4a2a;
            border-color: #FFC107;
            animation: pulse 2s infinite;
        }

        .hex-cell.available {
            background: #2a2a4a;
            border-color: #2196F3;
        }

        .hex-cell.ready {
            background: #4a3a1a;
            border-color: #FF9800;
            animation: readyGlow 1.5s infinite;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.4);
        }

        .hex-cell.unavailable {
            background: #2a2a2a;
            border-color: #666;
            color: #666;
            cursor: not-allowed;
            user-select: none;
        }

        .hex-cell.booster-target {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.2);
            animation: boosterTargetPulse 2s ease-in-out infinite;
        }

        .hex-cell.booster-invalid {
            border-color: #666;
            background: rgba(102, 102, 102, 0.1);
            cursor: not-allowed;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.8); }
        }

        @keyframes readyGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 152, 0, 0.4); }
            50% { box-shadow: 0 0 20px rgba(255, 152, 0, 0.8); }
        }

        /* Tutorial Modal */
        .tutorial-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.3s ease-in-out;
        }

        .tutorial-modal.show {
            opacity: 1;
            transform: scale(1);
        }

        .tutorial-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #4CAF50;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }

        .tutorial-modal.show .tutorial-content {
            transform: translateY(0);
        }

        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tutorial-header h3 {
            color: #4CAF50;
            margin: 0;
            font-size: 20px;
        }

        .tutorial-skip {
            background: #ff4444;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .tutorial-skip:hover {
            background: #ff6666;
        }

        .tutorial-description {
            color: #fff;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .tutorial-controls {
            display: flex;
            justify-content: center;
        }

        .tutorial-btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .tutorial-btn:hover {
            background: #45a049;
        }

        /* Achievements Panel */
        .achievements-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            backdrop-filter: blur(3px);
        }

        .achievements-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .achievements-header h3 {
            color: #FFD700;
            margin: 0;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #ff4444;
        }

        .achievements-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .achievement-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #666;
            transition: all 0.3s;
        }

        .achievement-item.completed {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .achievement-title {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .achievement-description {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .achievement-reward {
            color: #FFD700;
            font-size: 12px;
            font-weight: bold;
        }

        /* Achievements button in header */
        .achievements-btn {
            background: #FFD700;
            border: none;
            color: #000;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .achievements-btn:hover {
            background: #FFC107;
        }

        /* Tutorial Highlighting */
        .tutorial-highlight {
            position: relative;
            z-index: 1000;
            box-shadow: 0 0 0 4px #4CAF50, 0 0 0 8px rgba(76, 175, 80, 0.3) !important;
            border-radius: 8px !important;
            animation: tutorialPulse 2s ease-in-out infinite;
        }

        .tutorial-highlight::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 12px;
            z-index: -1;
            animation: tutorialGlow 2s ease-in-out infinite;
        }

        @keyframes tutorialPulse {
            0%, 100% { 
                box-shadow: 0 0 0 4px #4CAF50, 0 0 0 8px rgba(76, 175, 80, 0.3);
            }
            50% { 
                box-shadow: 0 0 0 6px #4CAF50, 0 0 0 12px rgba(76, 175, 80, 0.5);
            }
        }

        @keyframes tutorialGlow {
            0%, 100% { 
                background: rgba(76, 175, 80, 0.1);
            }
            50% { 
                background: rgba(76, 175, 80, 0.2);
            }
        }

        /* Tutorial pointer arrow */
        .tutorial-pointer {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 20px solid #4CAF50;
            z-index: 1500;
            animation: tutorialBounce 1s ease-in-out infinite;
        }

        @keyframes tutorialBounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Tutorial blocking overlay */
        .tutorial-blocking-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: 999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        /* Mini App specific styles */
        .mini-app-mode {
            /* Optimize for mobile Mini App view */
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
        }
        
        .mini-app-mode .header {
            /* Minimize header in Mini App mode */
            padding: 10px 15px;
        }
        
        .mini-app-mode .game-title h1 {
            font-size: 16px;
        }
        
        .mini-app-mode .main-container {
            /* Optimize layout for Mini App */
            grid-template-columns: 1fr;
            gap: 10px;
            padding: 10px;
        }
        
        .mini-app-mode .resource-panel,
        .mini-app-mode .booster-panel {
            /* Make panels more compact in Mini App */
            padding: 15px;
        }
        
        /* Mini App share button */
        .share-achievement-btn {
            background: #1DA1F2;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            transition: background 0.3s;
        }
        
        .share-achievement-btn:hover {
            background: #0d8bd1;
        }
        
        /* Mini App notification badge */
        .mini-app-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(29, 161, 242, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideInFromRight 0.3s ease-out;
        }
        
        @keyframes slideInFromRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .tutorial-blocking-overlay.active {
            pointer-events: all;
            opacity: 1;
        }

        /* Blocked elements during tutorial */
        .tutorial-blocked {
            pointer-events: none !important;
            opacity: 0.3 !important;
            filter: grayscale(70%) !important;
            cursor: not-allowed !important;
            position: relative;
            transition: all 0.3s ease-in-out !important;
        }

        .tutorial-blocked::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.2);
            z-index: 100;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        /* Allow highlighted elements to be clickable */
        .tutorial-highlight {
            pointer-events: all !important;
            opacity: 1 !important;
            filter: none !important;
            cursor: pointer !important;
            z-index: 1001 !important;
            transition: all 0.3s ease-in-out !important;
        }

        .tutorial-highlight::after {
            display: none !important;
        }

        /* Tutorial allowed elements */
        .tutorial-allowed {
            pointer-events: all !important;
            opacity: 1 !important;
            filter: none !important;
            z-index: 1000 !important;
            transition: all 0.3s ease-in-out !important;
        }

        /* Timer overlay */
        .timer {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            color: #FFC107;
            white-space: nowrap;
            z-index: 2;
            pointer-events: none;
            user-select: none;
        }

        /* Progress overlay for extracting cells */
        .progress-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, 
                rgba(255, 193, 7, 0.8) 0%, 
                rgba(255, 152, 0, 0.6) 50%, 
                rgba(255, 87, 34, 0.4) 100%);
            border-radius: 0 0 8px 8px;
            transition: height 0.5s ease;
            z-index: 1;
            box-shadow: 0 -2px 8px rgba(255, 193, 7, 0.3);
            pointer-events: none;
            user-select: none;
        }

        /* Enhanced extracting animation */
        .hex-cell.extracting {
            overflow: hidden;
        }

        .hex-cell.extracting .progress-overlay {
            animation: progressPulse 2s ease-in-out infinite;
        }

        /* Near completion effect */
        .progress-overlay.near-completion {
            background: linear-gradient(180deg, 
                rgba(76, 175, 80, 0.9) 0%, 
                rgba(139, 195, 74, 0.7) 50%, 
                rgba(255, 193, 7, 0.5) 100%);
            animation: nearCompletionGlow 1s ease-in-out infinite;
        }

        @keyframes progressPulse {
            0%, 100% { 
                box-shadow: 0 -2px 8px rgba(255, 193, 7, 0.3);
            }
            50% { 
                box-shadow: 0 -4px 12px rgba(255, 193, 7, 0.6);
            }
        }

        @keyframes nearCompletionGlow {
            0%, 100% { 
                box-shadow: 0 -2px 12px rgba(76, 175, 80, 0.4);
            }
            50% { 
                box-shadow: 0 -6px 18px rgba(76, 175, 80, 0.8);
            }
        }

        /* Resource Panel */
        .resource-panel {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #444;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(58, 58, 58, 0.8);
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            cursor: pointer;
            transition: all 0.3s;
        }

        .resource-item:hover {
            background: rgba(68, 68, 68, 0.8);
            transform: translateX(2px);
        }

        .resource-item.selected {
            background: rgba(76, 175, 80, 0.2);
            border-left-color: #8BC34A;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .resource-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .resource-name {
            font-size: 14px;
        }

        .resource-amount {
            font-weight: bold;
            color: #4CAF50;
        }

        .resource-value {
            font-size: 12px;
            color: #aaa;
        }

        .resource-cost {
            font-size: 12px;
            color: #FF9800;
            font-weight: bold;
        }

        /* Booster & Market Panel */
        .booster-panel {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #444;
            display: flex;
            flex-direction: column;
            max-height: 500px;
        }

        .tab-container {
            display: flex;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        #tabContent {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Custom scrollbar */
        #tabContent::-webkit-scrollbar {
            width: 8px;
        }

        #tabContent::-webkit-scrollbar-track {
            background: rgba(42, 42, 42, 0.5);
            border-radius: 4px;
        }

        #tabContent::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.7);
            border-radius: 4px;
        }

        #tabContent::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.9);
        }

        .tab {
            flex: 1;
            padding: 10px;
            background: #3a3a3a;
            border: none;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .tab:first-child {
            border-radius: 8px 0 0 8px;
        }

        .tab:last-child {
            border-radius: 0 8px 8px 0;
        }

        .booster-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(58, 58, 58, 0.8);
            border-radius: 8px;
            border-left: 4px solid #FF9800;
            cursor: pointer;
            transition: all 0.3s;
        }

        .booster-item:hover {
            background: rgba(68, 68, 68, 0.8);
        }

        .booster-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .booster-item.selected {
            background: rgba(255, 152, 0, 0.2);
            border-left-color: #FFB74D;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
        }

        .booster-info {
            flex: 1;
        }

        .booster-name {
            font-size: 14px;
            font-weight: bold;
        }

        .booster-effect {
            font-size: 12px;
            color: #aaa;
        }

        .booster-cost {
            color: #FF9800;
            font-weight: bold;
            font-size: 14px;
        }

        /* Progress indicators */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        /* Mobile Responsiveness */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .booster-panel {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }
            
            .player-info {
                gap: 15px;
            }
            
            .stat {
                min-width: 50px;
            }
            
            .stat-value {
                font-size: 14px;
            }
            
            .game-title h1 {
                font-size: 18px;
            }
            
            .main-container {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
            }
            
            .hex-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .hex-cell {
                width: 50px;
                height: 44px;
                font-size: 9px;
            }
        }

        @media (max-width: 480px) {
            .hex-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .hex-cell {
                width: 45px;
                height: 40px;
                font-size: 8px;
            }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .notification.warning {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
        }

        /* Loading overlay */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading.show {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            z-index: 10000;
            display: none;
            border: 2px solid #4CAF50;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            pointer-events: all;
        }

        .debug-panel div {
            margin-bottom: 10px;
        }

        .debug-panel label {
            font-weight: bold;
        }

        .debug-panel input[type="range"] {
            width: 100px;
        }

        .debug-panel button {
            padding: 5px 10px;
            background: #f44336;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        /* Boost indicators */
        .hex-cell.boosted {
            border-color: #2196F3;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.6);
            animation: boostGlow 2s ease-in-out infinite;
        }

        .boost-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #2196F3;
            color: white;
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 10px;
            z-index: 10;
            font-weight: bold;
            pointer-events: none;
        }

        .global-boost-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(255, 152, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: boostPulse 2s ease-in-out infinite;
        }

        @keyframes boostGlow {
            0%, 100% { 
                box-shadow: 0 0 15px rgba(33, 150, 243, 0.6);
            }
            50% { 
                box-shadow: 0 0 25px rgba(33, 150, 243, 0.9);
            }
        }

        @keyframes boostPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.9;
            }
            50% { 
                transform: scale(1.05);
                opacity: 1;
            }
        }

        @keyframes boosterTargetPulse {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(33, 150, 243, 0.8);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Tutorial Blocking Overlay -->
    <div id="tutorialBlockingOverlay" class="tutorial-blocking-overlay"></div>

    <!-- Debug Panel -->
    <div class="debug-panel tutorial-allowed" id="debugPanel" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9); padding: 10px; border-radius: 8px; color: white; font-size: 12px; z-index: 10000; display: none; border: 2px solid #4CAF50; box-shadow: 0 4px 20px rgba(0,0,0,0.8); pointer-events: all;">
        <div style="margin-bottom: 10px; font-weight: bold;">🔧 Debug Panel</div>
        <div style="margin-bottom: 5px;">
            <label>Speed Multiplier: <span id="speedDisplay">1x</span></label>
        </div>
        <div style="margin-bottom: 10px;">
            <input type="range" id="speedSlider" min="1" max="120" value="1" style="width: 100px;">
        </div>
        <div style="margin-bottom: 10px;">
            <button onclick="resetGame()" style="padding: 5px 10px; background: #ff4444; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 5px;">Reset Game</button>
            <button onclick="resetTutorial()" style="padding: 5px 10px; background: #2196F3; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 5px;">Reset Tutorial</button>
            <button onclick="toggleDebug()" style="padding: 5px 10px; background: #f44336; border: none; border-radius: 4px; color: white; cursor: pointer;">Hide</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="player-info">
            <div class="stat">
                <div class="stat-label">Level</div>
                <div class="stat-value" id="level">1</div>
            </div>
            <div class="stat">
                <div class="stat-label">XP</div>
                <div class="stat-value" id="xp">0 / 1000</div>
                <div class="progress-bar">
                    <div class="progress" id="xp-progress" style="width: 0%;"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-label">Points</div>
                <div class="stat-value" id="points">1000</div>
            </div>
            <div class="stat">
                <div class="stat-label">Cells</div>
                <div class="stat-value" id="cells">3 / 3</div>
            </div>
        </div>
        <div class="game-title">
            <h1>🌙 Farpost</h1>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <button onclick="showAchievements()" class="achievements-btn">🏆 Achievements</button>
                <button onclick="shareProgress()" class="share-achievement-btn" id="shareBtn" style="display: none;">📤 Share</button>
                <div id="userDisplay" style="font-size: 12px; color: #aaa; margin-left: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Map Container -->
        <div class="map-container">
            <div class="map-header">
                <div class="map-title">Lunar Territory</div>
                <div class="cell-info" id="cellInfo">Select a cell to manage</div>
            </div>
            
            <!-- Hexagonal Grid -->
            <div class="hex-grid" id="hexGrid">
                <!-- Cells will be dynamically generated -->
            </div>
        </div>

        <!-- Resource Panel -->
        <div class="resource-panel">
            <div class="panel-title">🚀 Deployment Center</div>
            <div id="resourceList">
                <!-- Expeditions and boosters will be dynamically generated -->
            </div>
        </div>

        <!-- Booster & Market Panel -->
        <div class="booster-panel">
            <div class="tab-container">
                <button class="tab active" id="buyTab">⛏️ Buy</button>
                <button class="tab" id="sellTab">💰 Sell</button>
            </div>
            
            <div id="tabContent">
                <!-- Tab content will be dynamically generated -->
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="tutorial-modal" style="display: none;">
        <div class="tutorial-content">
            <div class="tutorial-header">
                <h3 id="tutorialTitle">Tutorial Step</h3>
                <button onclick="skipTutorial()" class="tutorial-skip">Skip Tutorial</button>
            </div>
            <div id="tutorialDescription" class="tutorial-description">
                Follow the instructions to learn the game.
            </div>
            <div class="tutorial-controls">
                <button onclick="hideTutorialModal()" class="tutorial-btn tutorial-continue">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Achievements Panel -->
    <div id="achievementsPanel" class="achievements-panel" style="display: none;">
        <div class="achievements-content">
            <div class="achievements-header">
                <h3>🏆 Achievements</h3>
                <button onclick="hideAchievements()" class="close-btn">✕</button>
            </div>
            <div id="achievementsList" class="achievements-list">
                <!-- Achievements will be populated here -->
            </div>
        </div>
    </div>

    <!-- Include external scripts -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/farcaster.js"></script>

    <script>
        // Game state
        let gameState = {
            level: 1,
            xp: 0,
            points: 1000,
            ownedCells: 3,
            maxCells: 3,
            selectedExpedition: null,
            selectedBooster: null,
            resources: {
                'Lunar Regolith': 0,
                'Iron Ore': 0,
                'Aluminum': 0,
                'Water Ice': 0,
                'Magnesium': 0,
                'Silicon': 0,
                'Titanium': 0,
                'Rare Earth Elements': 0,
                'Platinum Group Metals': 0,
                'Helium-3': 0
            },
            expeditions: {
                'Lunar Regolith': 0,
                'Iron Ore': 0,
                'Aluminum': 0,
                'Water Ice': 0,
                'Magnesium': 0,
                'Silicon': 0,
                'Titanium': 0,
                'Rare Earth Elements': 0,
                'Platinum Group Metals': 0,
                'Helium-3': 0
            },
            boosters: {
                'Basic Booster': 0,
                'Advanced Booster': 0,
                'Elite Booster': 0,
                'Master Booster': 0,
                'Ultimate Booster': 0,
                'Instant Extract': 0
            },
            cells: Array(18).fill(null).map((_, index) => ({
                id: index,
                owned: [7, 8, 9].includes(index), // Middle cells owned by default
                resourceType: null,
                extractionStartTime: null,
                extractionEndTime: null,
                isReady: false
            })),
            activeTab: 'buy',
            mode: 'select', // 'select', 'deploy', 'booster'
            debugSpeed: 1,
            tutorial: {
                isActive: false,
                step: 0,
                completed: false,
                initialSetup: false
            },
            achievements: {
                'first_expedition': { completed: false, title: 'First Expedition', description: 'Deploy your first expedition', reward: 100 },
                'first_boost': { completed: false, title: 'Speed Demon', description: 'Use your first booster', reward: 50 },
                'first_collect': { completed: false, title: 'Resource Collector', description: 'Collect your first resource', reward: 75 },
                'first_sell': { completed: false, title: 'Merchant', description: 'Sell your first resource', reward: 100 },
                'second_expedition': { completed: false, title: 'Expanding Operations', description: 'Buy a second expedition', reward: 150 },
                'tutorial_complete': { completed: false, title: 'Graduate', description: 'Complete the tutorial', reward: 200 }
            }
        };

        // Game configuration
        const gameConfig = {
            resources: {
                'Lunar Regolith': { time: 0.5, cost: 20, value: 50, xp: 15, level: 1, symbol: 'LR' },
                'Iron Ore': { time: 1, cost: 30, value: 100, xp: 25, level: 1, symbol: 'Fe' },
                'Aluminum': { time: 2, cost: 35, value: 150, xp: 30, level: 1, symbol: 'Al' },
                'Water Ice': { time: 4, cost: 40, value: 200, xp: 35, level: 1, symbol: 'H2O' },
                'Magnesium': { time: 6, cost: 45, value: 180, xp: 40, level: 5, symbol: 'Mg' },
                'Silicon': { time: 8, cost: 50, value: 250, xp: 45, level: 5, symbol: 'Si' },
                'Titanium': { time: 12, cost: 80, value: 500, xp: 60, level: 5, symbol: 'Ti' },
                'Rare Earth Elements': { time: 16, cost: 150, value: 1500, xp: 100, level: 10, symbol: 'REE' },
                'Platinum Group Metals': { time: 20, cost: 200, value: 2000, xp: 120, level: 15, symbol: 'PGM' },
                'Helium-3': { time: 24, cost: 300, value: 5000, xp: 180, level: 20, symbol: 'He-3' }
            },
            boosters: {
                'Basic Booster': { cost: 100, multiplier: 2, level: 1 },
                'Advanced Booster': { cost: 250, multiplier: 3, level: 5 },
                'Elite Booster': { cost: 500, multiplier: 4, level: 10 },
                'Master Booster': { cost: 1000, multiplier: 5, level: 15 },
                'Ultimate Booster': { cost: 2000, multiplier: 10, level: 20 },
                'Instant Extract': { cost: 0, multiplier: 'instant', level: 1 }
            },
            levelThresholds: [0, 300, 1200, 2200, 3500, 5200, 7300, 9800, 12800, 16400, 20600],
            cellUnlocks: {
                1: 3, 2: 4, 3: 5, 10: 8, 15: 12, 20: 16, 25: 24, 30: 32, 35: 48, 40: 64
            }
        };

        // Initialize game
        async function initGame() {
            try {
                // Initialize API client
                const gameAPI = new FarpostAPI();
                await gameAPI.init();
                
                // Initialize Farcaster integration
                const farcasterIntegration = new FarcasterIntegration();
                const isFrameContext = await farcasterIntegration.init(gameAPI);
            
            // Store references globally
            window.gameAPI = gameAPI;
            window.farcasterIntegration = farcasterIntegration;
            
            // Set up auth state change handler
            gameAPI.onAuthStateChange = (event, session) => {
                if (event === 'signed_in') {
                    console.log('User signed in:', session?.user);
                    updateUserDisplay(session?.user);
                } else if (event === 'signed_out') {
                    console.log('User signed out');
                    updateUserDisplay(null);
                }
            };
            
            // Load game state (from Farcaster or local storage)
            if (!isFrameContext) {
                loadGameState();
            }
            
            // Check for tutorial setup (skip for Farcaster frames)
            if (!isFrameContext && !gameState.tutorial.initialSetup && !gameState.tutorial.completed) {
                setupTutorial();
            } else if (!isFrameContext && gameState.tutorial.isActive) {
                // If tutorial was active, restore its state properly
                setTimeout(() => {
                    showTutorialStep();
                }, 1000);
            }
            
            generateGrid();
            updateUI();
            setupEventListeners();
            setupTutorialClickPrevention();
            startGameLoop();
            
            // Add Farcaster user info to header if in frame context
            if (isFrameContext) {
                updateUserDisplay(farcasterIntegration.getUserInfo());
            }
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading').classList.remove('show');
            }, 500);
            
            } catch (error) {
                console.error('Error initializing game:', error);
                showNotification('Failed to initialize game. Please refresh the page.', 'error');
                
                // Hide loading screen even if there's an error
                setTimeout(() => {
                    document.getElementById('loading').classList.remove('show');
                }, 500);
            }
        }

        // Setup initial tutorial state
        function setupTutorial() {
            gameState.tutorial.isActive = true;
            gameState.tutorial.step = 0;
            gameState.tutorial.initialSetup = true;
            gameState.points = 100; // Enough to buy second expedition later
            gameState.expeditions['Lunar Regolith'] = 1; // Start with one expedition
            gameState.boosters['Instant Extract'] = 1; // Start with one instant booster
            
            showNotification('Welcome to Farpost! Let\'s begin the tutorial.', 'success');
            setTimeout(() => showTutorialStep(), 1000);
        }

        // Tutorial steps with fixed sell logic
        const tutorialSteps = [
            {
                title: "Welcome to Farpost!",
                description: "Welcome to Farpost, your lunar mining operation! Your goal is to extract valuable resources from the Moon's surface, sell them for points, and expand your mining empire. You'll deploy expeditions to owned cells, use boosters to speed up extraction, and strategically grow your operation. Let's start with the basics!",
                highlightSelector: null,
                allowedSelectors: [".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "welcome",
                checkComplete: () => true // This step just shows information
            },
            {
                title: "Deploy Your First Expedition",
                description: "Click on the 'Lunar Regolith' expedition in the Deploy section to select it.",
                highlightSelector: ".resource-item:has(.resource-name:contains('Lunar Regolith'))",
                allowedSelectors: [".resource-item:has(.resource-name:contains('Lunar Regolith'))", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "select_expedition",
                checkComplete: () => gameState.selectedExpedition === 'Lunar Regolith'
            },
            {
                title: "Deploy to Cell",
                description: "Perfect! Now click on one of the owned cells (the green ones in the middle) to deploy your expedition.",
                highlightSelector: ".hex-cell.owned",
                allowedSelectors: [".hex-cell.owned", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "deploy_expedition",
                checkComplete: () => gameState.cells.some(cell => cell.extractionStartTime && !cell.isReady)
            },
            {
                title: "Use Instant Extract Booster",
                description: "Click on 'Instant Extract' booster in the Apply Boosters section to select it.",
                highlightSelector: ".booster-item:has(.booster-name:contains('Instant Extract'))",
                allowedSelectors: [".booster-item:has(.booster-name:contains('Instant Extract'))", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "select_booster",
                checkComplete: () => gameState.selectedBooster === 'Instant Extract'
            },
            {
                title: "Apply Booster to Cell",
                description: "Now click on the extracting cell (yellow border) to instantly complete the extraction.",
                highlightSelector: ".hex-cell.extracting",
                allowedSelectors: [".hex-cell.extracting", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "apply_booster",
                checkComplete: () => gameState.cells.some(cell => cell.isReady)
            },
            {
                title: "Collect Resources",
                description: "Click on the glowing orange cell to collect your first resource!",
                highlightSelector: ".hex-cell.ready",
                allowedSelectors: [".hex-cell.ready", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "collect_resource",
                checkComplete: () => gameState.resources['Lunar Regolith'] > 0
            },
            {
                title: "Switch to Sell Tab",
                description: "Switch to the 'Sell' tab to access the market.",
                highlightSelector: "#sellTab",
                allowedSelectors: ["#sellTab", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "switch_tab",
                checkComplete: () => gameState.activeTab === 'sell'
            },
            {
                title: "Sell All Resources",
                description: "Perfect! Now click 'Sell All' to convert your resources to points.",
                highlightSelector: ".resource-item:has(.resource-name:contains('Sell All'))",
                allowedSelectors: [".resource-item:has(.resource-name:contains('Sell All'))", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "sell_resources",
                checkComplete: () => gameState.points > 100 && gameState.resources['Lunar Regolith'] === 0
            },
            {
                title: "Switch to Buy Tab",
                description: "Switch to the 'Buy' tab to purchase more expeditions.",
                highlightSelector: "#buyTab",
                allowedSelectors: ["#buyTab", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "switch_tab",
                checkComplete: () => gameState.activeTab === 'buy'
            },
            {
                title: "Purchase Second Expedition",
                description: "Now purchase another 'Lunar Regolith' expedition to expand your operations!",
                highlightSelector: ".resource-item:has(.resource-name:contains('Lunar Regolith'))",
                allowedSelectors: [".resource-item:has(.resource-name:contains('Lunar Regolith'))", ".tutorial-skip", ".tutorial-btn", ".tutorial-continue"],
                highlightAction: "purchase_expedition",
                checkComplete: () => gameState.expeditions['Lunar Regolith'] >= 1
            },
            {
                title: "Tutorial Complete!",
                description: "Congratulations! You've learned the basics of Farpost. Continue exploring and expanding your lunar operation!",
                highlightSelector: null,
                allowedSelectors: [],
                checkComplete: () => true // This step completes the tutorial
            }
        ];

        // Show tutorial step with improved UX flow
        function showTutorialStep() {
            if (!gameState.tutorial.isActive) return;
            
            const step = tutorialSteps[gameState.tutorial.step];
            if (!step) {
                completeTutorial();
                return;
            }
            
            console.log('Showing tutorial step:', gameState.tutorial.step, step.title);
            
            // Always clear any existing blocking/highlighting from previous step
            clearTutorialHighlights();
            unblockAllElements();
            
            // For first two steps (0 and 1), show immediately without animation
            if (gameState.tutorial.step <= 1) {
                showTutorialModal(step.title, step.description, false); // No animation
            } else {
                // For interactive steps, just show the modal - NO highlighting until modal is closed
                showTutorialModal(step.title, step.description, true);
            }
        }

        // Check tutorial progress - simplified without complex nextHighlight logic
        function checkTutorialProgress() {
            if (!gameState.tutorial.isActive) return;
            
            const step = tutorialSteps[gameState.tutorial.step];
            if (step && step.checkComplete()) {
                console.log('Tutorial step', gameState.tutorial.step, 'completed:', step.title);
                
                // Clear highlighting when step is completed
                clearTutorialHighlights();
                unblockAllElements();
                
                // Advance to next step
                gameState.tutorial.step++;
                console.log('Advancing to tutorial step:', gameState.tutorial.step);
                
                if (gameState.tutorial.step < tutorialSteps.length) {
                    // For steps 1-2, show immediately. For others, show with normal delay
                    if (gameState.tutorial.step <= 1) {
                        showTutorialStep(); // No delay for first two steps
                    } else {
                        setTimeout(() => showTutorialStep(), 500);
                    }
                } else {
                    completeTutorial();
                }
            }
        }

        // Complete tutorial
        function completeTutorial() {
            gameState.tutorial.isActive = false;
            gameState.tutorial.completed = true;
            
            // Clear all tutorial highlights and unblock elements
            clearTutorialHighlights();
            unblockAllElements();
            
            unlockAchievement('tutorial_complete');
            showNotification('Tutorial completed! You\'re now ready to explore Farpost on your own!', 'success');
            hideTutorialModal(true); // Skip progress check when completing tutorial
            saveGameState();
        }

        // Achievement system
        function unlockAchievement(achievementId) {
            const achievement = gameState.achievements[achievementId];
            if (!achievement || achievement.completed) return;
            
            achievement.completed = true;
            gameState.points += achievement.reward;
            
            showNotification(`🏆 Achievement Unlocked: ${achievement.title} (+${achievement.reward} points)`, 'success');
            
            // Send Mini App notification if available
            sendAchievementNotification(achievement.title);
            
            saveGameState();
        }

        // Check achievements
        function checkAchievements() {
            // Check first expedition
            if (!gameState.achievements.first_expedition.completed && 
                gameState.cells.some(cell => cell.extractionStartTime)) {
                unlockAchievement('first_expedition');
            }
            
            // Check first collect
            if (!gameState.achievements.first_collect.completed && 
                Object.values(gameState.resources).some(amount => amount > 0)) {
                unlockAchievement('first_collect');
            }
        }

        // Tutorial modal functions with improved UX
        function showTutorialModal(title, description, withAnimation = true) {
            document.getElementById('tutorialTitle').textContent = title;
            document.getElementById('tutorialDescription').textContent = description;
            const modal = document.getElementById('tutorialModal');
            modal.style.display = 'flex';
            
            if (withAnimation) {
                // Trigger smooth animation for interactive steps
                setTimeout(() => {
                    modal.classList.add('show');
                }, 50);
            } else {
                // Show immediately for intro steps
                modal.classList.add('show');
            }
        }

        function hideTutorialModal(skipProgressCheck = false) {
            const modal = document.getElementById('tutorialModal');
            modal.classList.remove('show');
            
            // Hide after animation completes
            setTimeout(() => {
                modal.style.display = 'none';
                
                // For interactive steps (3+), apply highlighting AFTER modal is completely hidden
                if (gameState.tutorial.isActive && gameState.tutorial.step >= 2 && !skipProgressCheck) {
                    applyTutorialHighlighting();
                }
                
                // Check tutorial progress after modal is hidden (only when called by user interaction)
                if (gameState.tutorial.isActive && !skipProgressCheck) {
                    setTimeout(() => checkTutorialProgress(), 100);
                }
            }, 300);
        }

        // Apply tutorial highlighting and blocking after modal is hidden
        function applyTutorialHighlighting() {
            const step = tutorialSteps[gameState.tutorial.step];
            if (!step) return;
            
            console.log('Applying highlighting for step:', gameState.tutorial.step, step.title);
            console.log('Highlight selector:', step.highlightSelector);
            console.log('Allowed selectors:', step.allowedSelectors);
            
            // Block all elements first
            blockAllElements();
            
            // Allow only specific elements for this step
            allowElements(step.allowedSelectors);
            
            // Add highlighting
            if (step.highlightSelector) {
                highlightElement(step.highlightSelector);
                console.log('Applied highlighting to:', step.highlightSelector);
            }
        }

        function skipTutorial() {
            if (confirm('Are you sure you want to skip the tutorial? You can restart later by resetting the game.')) {
                gameState.tutorial.isActive = false;
                gameState.tutorial.completed = true;
                clearTutorialHighlights();
                unblockAllElements();
                hideTutorialModal(true); // Skip progress check when skipping tutorial
                saveGameState();
                showNotification('Tutorial skipped. Welcome to Farpost!', 'info');
            }
        }

        // Achievements modal functions
        function showAchievements() {
            updateAchievementsList();
            document.getElementById('achievementsPanel').style.display = 'flex';
        }

        function hideAchievements() {
            document.getElementById('achievementsPanel').style.display = 'none';
        }

        function updateAchievementsList() {
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = '';
            
            Object.entries(gameState.achievements).forEach(([id, achievement]) => {
                const item = document.createElement('div');
                item.className = `achievement-item ${achievement.completed ? 'completed' : ''}`;
                item.innerHTML = `
                    <div class="achievement-title">${achievement.completed ? '✅' : '⬜'} ${achievement.title}</div>
                    <div class="achievement-description">${achievement.description}</div>
                    <div class="achievement-reward">Reward: ${achievement.reward} points</div>
                `;
                achievementsList.appendChild(item);
            });
        }

        // Tutorial highlighting functions
        function highlightElement(selector) {
            // Remove existing highlights
            clearTutorialHighlights();
            
            if (!selector) return;
            
            const elements = findElementsBySelector(selector);
            
            elements.forEach(element => {
                if (element) {
                    element.classList.add('tutorial-highlight');
                }
            });
        }

        function clearTutorialHighlights() {
            document.querySelectorAll('.tutorial-highlight').forEach(element => {
                element.classList.remove('tutorial-highlight');
            });
        }

        // Tutorial blocking functions
        function blockAllElements() {
            const interactiveElements = [
                '.hex-cell',
                '.resource-item',
                '.booster-item', 
                '.tab',
                '.achievements-btn',
                '.debug-panel button',
                '#debugPanel'
            ];
            
            interactiveElements.forEach(selector => {
                document.querySelectorAll(selector).forEach(element => {
                    element.classList.add('tutorial-blocked');
                });
            });
            
            // Activate blocking overlay
            const overlay = document.getElementById('tutorialBlockingOverlay');
            overlay.classList.add('active');
        }

        function unblockAllElements() {
            document.querySelectorAll('.tutorial-blocked').forEach(element => {
                element.classList.remove('tutorial-blocked');
            });
            
            document.querySelectorAll('.tutorial-allowed').forEach(element => {
                element.classList.remove('tutorial-allowed');
            });
            
            // Deactivate blocking overlay
            const overlay = document.getElementById('tutorialBlockingOverlay');
            overlay.classList.remove('active');
        }

        function allowElements(selectors) {
            if (!selectors) return;
            
            selectors.forEach(selector => {
                const elements = findElementsBySelector(selector);
                elements.forEach(element => {
                    element.classList.remove('tutorial-blocked');
                    element.classList.add('tutorial-allowed');
                });
            });
            
            // Always allow tutorial modal controls and debug panel
            document.querySelectorAll('.tutorial-btn, .tutorial-skip, .tutorial-continue, .debug-panel, .debug-panel *, #debugPanel, #debugPanel *').forEach(element => {
                element.classList.remove('tutorial-blocked');
                element.classList.add('tutorial-allowed');
            });
        }

        function findElementsBySelector(selector) {
            // Handle complex selectors that don't work with :has() in older browsers
            let elements = [];
            
            if (selector.includes(":has(.resource-name:contains('Lunar Regolith'))")) {
                const resourceItems = document.querySelectorAll('.resource-item');
                elements = Array.from(resourceItems).filter(item => {
                    const nameElement = item.querySelector('.resource-name');
                    return nameElement && nameElement.textContent.includes('Lunar Regolith');
                });
            } else if (selector.includes(":has(.booster-name:contains('Instant Extract'))")) {
                const boosterItems = document.querySelectorAll('.booster-item');
                elements = Array.from(boosterItems).filter(item => {
                    const nameElement = item.querySelector('.booster-name');
                    return nameElement && nameElement.textContent.includes('Instant Extract');
                });
            } else if (selector.includes(":has(.resource-name:contains('Sell All'))")) {
                const resourceItems = document.querySelectorAll('.resource-item');
                elements = Array.from(resourceItems).filter(item => {
                    const nameElement = item.querySelector('.resource-name');
                    return nameElement && nameElement.textContent.includes('Sell All');
                });
            } else if (selector === ".hex-cell.owned") {
                // Find all owned cells (cells that are owned but not extracting or ready)
                elements = Array.from(document.querySelectorAll('.hex-cell')).filter(cell => {
                    return cell.classList.contains('owned') && 
                           !cell.classList.contains('extracting') && 
                           !cell.classList.contains('ready');
                });
            } else if (selector === ".hex-cell.extracting") {
                elements = Array.from(document.querySelectorAll('.hex-cell.extracting'));
            } else if (selector === ".hex-cell.ready") {
                elements = Array.from(document.querySelectorAll('.hex-cell.ready'));
            } else {
                elements = Array.from(document.querySelectorAll(selector));
            }
            
            return elements;
        }

        // Add global click prevention for blocked elements
        function setupTutorialClickPrevention() {
            document.addEventListener('click', function(event) {
                if (!gameState.tutorial.isActive) return;
                
                const target = event.target.closest('.tutorial-blocked');
                if (target) {
                    event.preventDefault();
                    event.stopPropagation();
                    showNotification('Follow the tutorial instructions! Click on the highlighted element.', 'warning');
                    return false;
                }
            }, true); // Use capture phase to intercept early
        }

        // Generate hexagonal grid
        function generateGrid() {
            const grid = document.getElementById('hexGrid');
            grid.innerHTML = '';
            
            gameState.cells.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.className = 'hex-cell tooltip';
                cellElement.dataset.index = index;
                cellElement.onclick = () => selectCell(index);
                
                updateCellDisplay(cellElement, cell);
                grid.appendChild(cellElement);
            });
        }

        // Update cell display
        function updateCellDisplay(element, cell) {
            const index = parseInt(element.dataset.index);
            element.className = 'hex-cell tooltip';
            
            // Clear any existing overlays and indicators
            const existingOverlay = element.querySelector('.progress-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            const existingBoostIndicator = element.querySelector('.boost-indicator');
            if (existingBoostIndicator) {
                existingBoostIndicator.remove();
            }
            
            // Check if cell has specific boost applied
            const cellHasBoost = cell.boostMultiplier && cell.boostMultiplier > 1;
            
            // Add booster mode visual indicators
            if (gameState.mode === 'booster' && gameState.selectedBooster && cell.owned) {
                if (cell.extractionStartTime && !cell.isReady) {
                    // Check if cell already has a booster applied
                    if (cell.boostMultiplier) {
                        element.classList.add('booster-invalid');
                    } else {
                        element.classList.add('booster-target');
                    }
                } else {
                    element.classList.add('booster-invalid');
                }
            }
            
            if (!cell.owned) {
                const canBuy = gameState.points >= 500 && gameState.ownedCells < gameState.maxCells;
                if (canBuy) {
                    element.classList.add('available');
                    element.textContent = '+';
                    element.dataset.tooltip = 'Click to buy for 500 pts';
                } else {
                    element.classList.add('unavailable');
                    element.textContent = '🔒';
                    if (gameState.ownedCells >= gameState.maxCells) {
                        element.dataset.tooltip = 'Max cells reached for your level';
                    } else {
                        element.dataset.tooltip = 'Not enough points (need 500)';
                    }
                }
            } else if (cell.isReady) {
                element.classList.add('ready');
                element.textContent = gameConfig.resources[cell.resourceType]?.symbol || '';
                let tooltip = `${cell.resourceType} - Ready to collect!`;
                
                // Update tooltip for booster mode
                if (gameState.mode === 'booster' && gameState.selectedBooster) {
                    if (cell.boostMultiplier) {
                        tooltip += ` (Already has ${cell.boosterName} applied)`;
                    } else {
                        tooltip += ' (Click to speed up extraction)';
                    }
                }
                
                element.dataset.tooltip = tooltip;
            } else if (cell.extractionStartTime) {
                element.classList.add('extracting');
                element.textContent = gameConfig.resources[cell.resourceType]?.symbol || '';
                
                // Add boost indicator if this cell is boosted
                if (cellHasBoost) {
                    element.classList.add('boosted');
                    const boostIndicator = document.createElement('div');
                    boostIndicator.className = 'boost-indicator';
                    boostIndicator.textContent = `${cell.boostMultiplier}x`;
                    element.appendChild(boostIndicator);
                }
                
                // Create or update timer
                const timer = element.querySelector('.timer') || document.createElement('div');
                timer.className = 'timer';
                if (!element.querySelector('.timer')) {
                    element.appendChild(timer);
                }
                
                // Create progress overlay
                const progressOverlay = document.createElement('div');
                progressOverlay.className = 'progress-overlay';
                
                // Calculate progress
                const totalTime = cell.extractionEndTime - cell.extractionStartTime;
                const elapsed = Date.now() - cell.extractionStartTime;
                const progress = Math.min(100, Math.max(0, (elapsed / totalTime) * 100));
                
                // Add near-completion effect
                if (progress > 80) {
                    progressOverlay.classList.add('near-completion');
                }
                
                // Set progress height (rising from bottom)
                progressOverlay.style.height = `${progress}%`;
                element.appendChild(progressOverlay);
                
                // Update timer display
                const remaining = Math.max(0, cell.extractionEndTime - Date.now());
                const totalMinutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const timeStr = `${totalMinutes}:${seconds.toString().padStart(2, '0')}`;
                timer.textContent = timeStr;
                
                let tooltipText = `${cell.resourceType} - ${timeStr} remaining (${Math.round(progress)}%)`;
                if (cellHasBoost) {
                    const multiplier = cell.boostMultiplier;
                    tooltipText += ` - ${multiplier}x boost active`;
                }
                
                // Update tooltip for booster mode
                if (gameState.mode === 'booster' && gameState.selectedBooster) {
                    if (cell.boostMultiplier) {
                        tooltipText += ` (Already has ${cell.boosterName} applied)`;
                    } else {
                        tooltipText += ' (Click to speed up extraction)';
                    }
                }
                
                element.dataset.tooltip = tooltipText;
            } else {
                element.classList.add('owned');
                element.textContent = '⚡';
                let tooltip = 'Owned cell - Ready for expedition';
                
                // Update tooltip for booster mode
                if (gameState.mode === 'booster' && gameState.selectedBooster) {
                    tooltip = `Cannot apply booster to empty cell (need extracting cell)`;
                }
                
                element.dataset.tooltip = tooltip;
            }
        }

        // Select cell
        function selectCell(index) {
            const cell = gameState.cells[index];
            
            if (!cell.owned) {
                const canBuy = gameState.points >= 500 && gameState.ownedCells < gameState.maxCells;
                if (canBuy) {
                    if (confirm(`Purchase this cell for 500 points?`)) {
                        buyCell(index);
                    }
                } else if (gameState.ownedCells >= gameState.maxCells) {
                    showNotification('You have reached the maximum number of cells for your level!', 'warning');
                } else {
                    showNotification('Not enough points to purchase this cell!', 'error');
                }
                return;
            }
            
            if (cell.isReady) {
                collectResource(index);
                return;
            }
            
            // Handle different modes
            if (gameState.mode === 'deploy' && gameState.selectedExpedition) {
                deployExpedition(index);
                return;
            }
            
            if (gameState.mode === 'booster' && gameState.selectedBooster) {
                applyBoosterToCell(index);
                return;
            }
            
            if (cell.extractionStartTime) {
                if (gameState.mode === 'booster' && gameState.selectedBooster) {
                    applyBoosterToCell(index);
                    return;
                }
                showNotification('This cell is already extracting! Wait for completion or select a different action.', 'warning');
                return;
            }
            
            // If we get here, the cell is owned but not doing anything - show a message
            showNotification('Cell is ready for expedition. Purchase and deploy expeditions from the Buy tab!', 'info');
        }

        // Update cell info display
        function updateCellInfo() {
            const cellInfo = document.getElementById('cellInfo');
            
            if (gameState.mode === 'deploy' && gameState.selectedExpedition) {
                cellInfo.textContent = `Deploy ${gameState.selectedExpedition} • Right-click or ESC to deselect`;
                return;
            }
            
            if (gameState.mode === 'booster' && gameState.selectedBooster) {
                cellInfo.textContent = `Click extracting cells to speed up • Right-click or ESC to deselect`;
                return;
            }
            
            // Default message
            cellInfo.textContent = 'Buy expeditions, then deploy from Deployment Center';
        }

        // Buy cell
        function buyCell(index = null) {
            if (index === null) {
                // Find first available cell
                index = gameState.cells.findIndex(cell => !cell.owned);
                if (index === -1) {
                    showNotification('No cells available for purchase!', 'error');
                    return;
                }
            }
            
            if (gameState.points < 500) {
                showNotification('Not enough points!', 'error');
                return;
            }
            
            if (gameState.ownedCells >= gameState.maxCells) {
                showNotification('Maximum cells reached for your level!', 'warning');
                return;
            }
            
            gameState.points -= 500;
            gameState.ownedCells++;
            gameState.cells[index].owned = true;
            gameState.xp += 150;
            
            showNotification('Cell purchased successfully!', 'success');
            checkLevelUp();
            updateUI();
            saveGameState();
        }

        // Deploy expedition to cell
        function deployExpedition(index) {
            const cell = gameState.cells[index];
            
            if (!cell.owned) {
                showNotification('This cell is not owned!', 'error');
                return;
            }
            
            if (cell.extractionStartTime) {
                showNotification('This cell is already extracting!', 'warning');
                return;
            }
            
            if (cell.isReady) {
                showNotification('Collect the current resource first!', 'warning');
                return;
            }
            
            if (gameState.expeditions[gameState.selectedExpedition] === 0) {
                showNotification(`No ${gameState.selectedExpedition} expeditions in inventory!`, 'error');
                return;
            }
            
            const resourceConfig = gameConfig.resources[gameState.selectedExpedition];
            
            // Calculate extraction time in milliseconds (time is now in minutes)
            let extractionTime = resourceConfig.time * 60 * 1000; // Convert minutes to milliseconds
            
            // Apply debug speed multiplier
            extractionTime = Math.floor(extractionTime / gameState.debugSpeed);
            
            // Deploy expedition (use inventory, no cost)
            gameState.expeditions[gameState.selectedExpedition]--;
            cell.resourceType = gameState.selectedExpedition;
            cell.extractionStartTime = Date.now();
            cell.extractionEndTime = Date.now() + extractionTime;
            cell.isReady = false;
            
            const remaining = gameState.expeditions[gameState.selectedExpedition];
            if (remaining === 0) {
                showNotification(`Deployed last ${cell.resourceType} expedition! Buy more to continue.`, 'warning');
                // Auto-deselect when no more expeditions available
                gameState.selectedExpedition = null;
                gameState.mode = 'select';
            } else {
                showNotification(`Deployed ${cell.resourceType} expedition! (${remaining} remaining)`, 'success');
            }
            
            // Check achievements and tutorial
            checkAchievements();
            checkTutorialProgress();
            
            updateUI();
            saveGameState();
        }

        // Collect resource
        function collectResource(index) {
            const cell = gameState.cells[index];
            
            // Additional validation - check if extraction is actually complete
            if (!cell.isReady) {
                showNotification('Resource is not ready for collection yet!', 'warning');
                return;
            }
            
            if (!cell.extractionEndTime || Date.now() < cell.extractionEndTime) {
                showNotification('Extraction still in progress!', 'warning');
                return;
            }
            
            const resourceType = cell.resourceType; // Store before resetting
            const resourceConfig = gameConfig.resources[resourceType];
            gameState.resources[resourceType]++;
            gameState.xp += resourceConfig.xp;
            
            // Reset cell (including booster properties)
            cell.resourceType = null;
            cell.extractionStartTime = null;
            cell.extractionEndTime = null;
            cell.isReady = false;
            cell.boostMultiplier = null;
            cell.boosterAppliedTime = null;
            cell.boosterName = null;
            
            showNotification(`Collected ${resourceType}!`, 'success');
            checkLevelUp();
            
            // Check achievements and tutorial
            checkAchievements();
            checkTutorialProgress();
            
            updateUI();
            saveGameState();
        }

        // Sell resources
        function sellResources() {
            let totalValue = 0;
            let soldItems = 0;
            
            Object.entries(gameState.resources).forEach(([resourceType, amount]) => {
                if (amount > 0) {
                    const value = gameConfig.resources[resourceType].value * amount;
                    totalValue += value;
                    soldItems += amount;
                    gameState.resources[resourceType] = 0;
                }
            });
            
            if (totalValue === 0) {
                showNotification('No resources to sell!', 'warning');
                return;
            }
            
            gameState.points += totalValue;
            gameState.xp += Math.floor(totalValue * 0.05); // 5% of sale value as XP
            
            showNotification(`Sold ${soldItems} resources for ${totalValue} points!`, 'success');
            
            // Check first sell achievement
            if (!gameState.achievements.first_sell.completed) {
                unlockAchievement('first_sell');
            }
            
            checkLevelUp();
            checkTutorialProgress();
            
            updateUI();
            saveGameState();
        }

        // Check level up
        function checkLevelUp() {
            const nextThreshold = gameConfig.levelThresholds[gameState.level];
            
            if (nextThreshold && gameState.xp >= nextThreshold) {
                gameState.level++;
                
                // Update max cells based on level
                const newMaxCells = Object.entries(gameConfig.cellUnlocks)
                    .filter(([level, _]) => parseInt(level) <= gameState.level)
                    .pop()?.[1] || 3;
                
                gameState.maxCells = newMaxCells;
                
                showNotification(`Level up! You are now level ${gameState.level}!`, 'success');
                updateUI();
                saveGameState();
            }
        }

        // Update UI
        function updateUI() {
            // Update header stats
            document.getElementById('level').textContent = gameState.level;
            const currentThreshold = gameConfig.levelThresholds[gameState.level - 1] || 0;
            const nextThreshold = gameConfig.levelThresholds[gameState.level];
            
            if (nextThreshold) {
                const xpInCurrentLevel = gameState.xp - currentThreshold;
                const xpNeededForLevel = nextThreshold - currentThreshold;
                const xpProgress = (xpInCurrentLevel / xpNeededForLevel) * 100;
                document.getElementById('xp').textContent = `${Math.max(0, xpInCurrentLevel)} / ${xpNeededForLevel}`;
                document.getElementById('xp-progress').style.width = `${Math.max(0, Math.min(100, xpProgress))}%`;
            } else {
                document.getElementById('xp').textContent = `${gameState.xp} / MAX`;
                document.getElementById('xp-progress').style.width = '100%';
            }
            
            document.getElementById('points').textContent = gameState.points.toLocaleString();
            document.getElementById('cells').textContent = `${gameState.ownedCells} / ${gameState.maxCells}`;
            
            // Update cells
            document.querySelectorAll('.hex-cell').forEach((element, index) => {
                updateCellDisplay(element, gameState.cells[index]);
            });

            // Update tab content
            updateTabContent();
            
            // Update resource list in separate panel
            updateResourceList();
            
            // Update cell info
            updateCellInfo();
            
            // Only refresh tutorial highlighting if we're in an interactive step AND modal is not visible
            if (gameState.tutorial.isActive && gameState.tutorial.step >= 2) {
                const modal = document.getElementById('tutorialModal');
                const isModalVisible = modal.style.display === 'flex' && modal.classList.contains('show');
                
                if (!isModalVisible) {
                    const step = tutorialSteps[gameState.tutorial.step];
                    if (step) {
                        setTimeout(() => {
                            // Reapply blocking and allowing only if modal is not visible
                            blockAllElements();
                            allowElements(step.allowedSelectors);
                            
                            // Reapply highlighting
                            if (step.highlightSelector) {
                                highlightElement(step.highlightSelector);
                            }
                        }, 100);
                    }
                }
            }
        }

        // Update resource list in the separate panel
        function updateResourceList() {
            const resourceList = document.getElementById('resourceList');
            resourceList.innerHTML = '';
            
            // Add expeditions section
            const expeditionTitle = document.createElement('div');
            expeditionTitle.className = 'panel-title';
            expeditionTitle.textContent = 'Deploy Expeditions';
            expeditionTitle.style.marginBottom = '10px';
            resourceList.appendChild(expeditionTitle);
            
            let hasExpeditions = false;
            Object.entries(gameConfig.resources).forEach(([resourceType, resourceConfig]) => {
                if (resourceConfig.level <= gameState.level) {
                    const amount = gameState.expeditions[resourceType] || 0;
                    const isSelected = gameState.selectedExpedition === resourceType;
                    const hasExp = amount > 0;
                    
                    if (hasExp) hasExpeditions = true;
                    
                    const item = document.createElement('div');
                    item.className = `resource-item ${isSelected ? 'selected' : ''} ${!hasExp ? 'disabled' : ''}`;
                    item.innerHTML = `
                        <div>
                            <div class="resource-name">${resourceType}</div>
                            <div class="resource-value">${resourceConfig.time}m duration | ${resourceConfig.value} pts reward</div>
                        </div>
                        <div class="resource-amount">${amount}</div>
                    `;
                    
                    if (hasExp) {
                        item.onclick = () => selectExpedition(resourceType);
                    }
                    
                    resourceList.appendChild(item);
                }
            });
            
            if (!hasExpeditions) {
                const noExpeditions = document.createElement('div');
                noExpeditions.className = 'resource-item disabled';
                noExpeditions.innerHTML = `
                    <div>
                        <div class="resource-name">Purchase expeditions from the Buy tab</div>
                        <div class="resource-value">Select an expedition type above to deploy</div>
                    </div>
                    <div class="resource-amount">ℹ️</div>
                `;
                resourceList.appendChild(noExpeditions);
            }
            
            // Add boosters section
            const boosterTitle = document.createElement('div');
            boosterTitle.className = 'panel-title';
            boosterTitle.textContent = 'Apply Boosters';
            boosterTitle.style.marginTop = '20px';
            boosterTitle.style.marginBottom = '10px';
            resourceList.appendChild(boosterTitle);
            
            let hasBoosters = false;
            Object.entries(gameConfig.boosters).forEach(([boosterName, boosterConfig]) => {
                if (boosterConfig.level <= gameState.level) {
                    const amount = gameState.boosters[boosterName] || 0;
                    const isSelected = gameState.selectedBooster === boosterName;
                    const hasBoost = amount > 0;
                    
                    if (hasBoost) hasBoosters = true;
                    
                    const item = document.createElement('div');
                    item.className = `booster-item ${isSelected ? 'selected' : ''} ${!hasBoost ? 'disabled' : ''}`;
                    
                    const effectText = boosterName === 'Instant Extract' 
                        ? 'Instantly completes extraction'
                        : `${boosterConfig.multiplier}x speed - per extraction`;
                    
                    item.innerHTML = `
                        <div class="booster-info">
                            <div class="booster-name">${boosterName}</div>
                            <div class="booster-effect">${effectText}</div>
                            ${!hasBoost ? '<div class="booster-effect">No boosters owned</div>' : ''}
                        </div>
                        <div class="booster-cost">${amount}</div>
                    `;
                    
                    if (hasBoost) {
                        item.onclick = () => selectBooster(boosterName);
                    }
                    
                    resourceList.appendChild(item);
                }
            });
            
            if (!hasBoosters) {
                const noBoosters = document.createElement('div');
                noBoosters.className = 'booster-item disabled';
                noBoosters.innerHTML = `
                    <div class="booster-info">
                        <div class="booster-name">No boosters owned</div>
                        <div class="booster-effect">Purchase boosters from the Buy tab</div>
                    </div>
                    <div class="booster-cost">0</div>
                `;
                resourceList.appendChild(noBoosters);
            }
        }

        // Update tab content
        function updateTabContent() {
            const tabContent = document.getElementById('tabContent');
            
            if (gameState.activeTab === 'buy') {
                tabContent.innerHTML = '<div class="panel-title">Purchase Expeditions</div>';
                
                Object.entries(gameConfig.resources).forEach(([resourceType, config]) => {
                    // During tutorial, only show the purchase option on the final step
                    const isTutorialActive = gameState.tutorial.isActive;
                    const isFinalTutorialStep = gameState.tutorial.step >= 7; // Buy second expedition step
                    
                    if (isTutorialActive && !isFinalTutorialStep) {
                        // Skip showing all purchase options during early tutorial
                        return;
                    }
                    
                    const canAfford = gameState.points >= config.cost;
                    const levelOk = gameState.level >= config.level;
                    const isDisabled = !canAfford || !levelOk;
                    
                    const item = document.createElement('div');
                    item.className = `resource-item ${isDisabled ? 'disabled' : ''}`;
                    item.innerHTML = `
                        <div>
                            <div class="resource-name">${resourceType}</div>
                            <div class="resource-value">${config.value} pts reward | ${config.time}m duration</div>
                            <div class="resource-cost">Cost: ${config.cost} pts</div>
                            ${!levelOk ? `<div class="resource-cost" style="color: #f44336;">Requires Level ${config.level}</div>` : ''}
                        </div>
                        <div class="resource-amount">Buy</div>
                    `;
                    
                    if (!isDisabled) {
                        item.onclick = () => purchaseExpedition(resourceType);
                    }
                    
                    tabContent.appendChild(item);
                });
                
                // Add booster section
                const boosterSection = document.createElement('div');
                boosterSection.innerHTML = '<div class="panel-title" style="margin-top: 20px;">Purchase Boosters</div>';
                tabContent.appendChild(boosterSection);
                
                Object.entries(gameConfig.boosters).forEach(([boosterName, config]) => {
                    // Skip Instant Extract boosters in buy tab
                    if (boosterName === 'Instant Extract') return;
                    
                    const canAfford = gameState.points >= config.cost;
                    const levelOk = gameState.level >= config.level;
                    const isDisabled = !canAfford || !levelOk;
                    
                    const item = document.createElement('div');
                    item.className = `booster-item ${isDisabled ? 'disabled' : ''}`;
                    item.innerHTML = `
                        <div class="booster-info">
                            <div class="booster-name">${boosterName}</div>
                            <div class="booster-effect">${config.multiplier}x speed - per extraction</div>
                            ${!levelOk ? `<div class="booster-effect" style="color: #f44336;">Requires Level ${config.level}</div>` : ''}
                        </div>
                        <div class="booster-cost">${config.cost}</div>
                    `;
                    
                    if (!isDisabled) {
                        item.onclick = () => purchaseBooster(boosterName);
                    }
                    
                    tabContent.appendChild(item);
                });
                
            } else if (gameState.activeTab === 'sell') {
                // Show collected resources inventory with sell functionality
                tabContent.innerHTML = '<div class="panel-title">Collected Resources</div>';
                
                let hasResources = false;
                Object.entries(gameState.resources).forEach(([resourceType, amount]) => {
                    if (amount > 0) {
                        hasResources = true;
                        const resourceConfig = gameConfig.resources[resourceType];
                        const totalValue = resourceConfig.value * amount;
                        const item = document.createElement('div');
                        item.className = 'resource-item';
                        item.innerHTML = `
                            <div>
                                <div class="resource-name">${resourceType}</div>
                                <div class="resource-value">Value: ${resourceConfig.value} pts each (Total: ${totalValue} pts)</div>
                            </div>
                            <div class="resource-amount">${amount} 
                                <button class="action-btn" style="margin-left: 10px; padding: 5px 10px; font-size: 10px;" onclick="sellSingleResource('${resourceType}')">Sell</button>
                            </div>
                        `;
                        tabContent.appendChild(item);
                    }
                });
                
                if (hasResources) {
                    // Add sell all button
                    const sellAllButton = document.createElement('div');
                    sellAllButton.className = 'resource-item';
                    sellAllButton.style.background = 'rgba(76, 175, 80, 0.2)';
                    sellAllButton.style.borderLeft = '4px solid #4CAF50';
                    sellAllButton.innerHTML = `
                        <div>
                            <div class="resource-name">💰 Sell All Resources</div>
                            <div class="resource-value">Convert all resources to points</div>
                        </div>
                        <div class="resource-amount">Sell All</div>
                    `;
                    sellAllButton.onclick = () => sellResources();
                    tabContent.appendChild(sellAllButton);
                } else {
                    const noResources = document.createElement('div');
                    noResources.className = 'resource-item disabled';
                    noResources.innerHTML = `
                        <div>
                            <div class="resource-name">No resources collected yet</div>
                            <div class="resource-value">Deploy expeditions to collect resources</div>
                        </div>
                        <div class="resource-amount">0</div>
                    `;
                    tabContent.appendChild(noResources);
                }
            }
        }

        // Sell single resource
        function sellSingleResource(resourceType) {
            const amount = gameState.resources[resourceType];
            if (amount === 0) {
                showNotification(`No ${resourceType} to sell!`, 'warning');
                return;
            }
            
            const value = gameConfig.resources[resourceType].value * amount;
            gameState.points += value;
            gameState.resources[resourceType] = 0;
            gameState.xp += Math.floor(value * 0.05);
            
            showNotification(`Sold ${amount} ${resourceType} for ${value} points!`, 'success');
            checkLevelUp();
            updateUI();
            saveGameState();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.getElementById('buyTab').onclick = () => {
                gameState.activeTab = 'buy';
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById('buyTab').classList.add('active');
                updateUI();
                
                // Check tutorial progress after tab switch
                setTimeout(() => checkTutorialProgress(), 100);
            };
            
            document.getElementById('sellTab').onclick = () => {
                gameState.activeTab = 'sell';
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById('sellTab').classList.add('active');
                updateUI();
                
                // Check tutorial progress after tab switch
                setTimeout(() => checkTutorialProgress(), 100);
            };
            
            // Debug panel controls
            document.getElementById('speedSlider').oninput = updateDebugSpeed;
            
            // Initialize debug display
            document.getElementById('speedDisplay').textContent = `${gameState.debugSpeed}x`;
            document.getElementById('speedSlider').value = gameState.debugSpeed;
            
            // Right-click anywhere to deselect
            document.addEventListener('contextmenu', function(e) {
                if (gameState.selectedExpedition || gameState.selectedBooster) {
                    e.preventDefault();
                    deselectAll();
                }
            });
            
            // ESC key to deselect
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    deselectAll();
                }
            });
        }
        
        // Deselect all selections
        function deselectAll() {
            if (gameState.selectedExpedition || gameState.selectedBooster) {
                const wasSelected = gameState.selectedExpedition || gameState.selectedBooster;
                gameState.selectedExpedition = null;
                gameState.selectedBooster = null;
                gameState.mode = 'select';
                showNotification(`Deselected ${wasSelected}.`, 'info');
                updateUI();
            }
        }

        // Game loop
        function startGameLoop() {
            // Main game logic updates (slower)
            setInterval(() => {
                const now = Date.now();
                let updated = false;
                
                // Check extraction timers (apply debug speed)
                gameState.cells.forEach(cell => {
                    if (cell.extractionEndTime && now >= cell.extractionEndTime && !cell.isReady) {
                        cell.isReady = true;
                        updated = true;
                    }
                });
                
                if (updated) {
                    updateUI();
                    saveGameState();
                }
            }, Math.max(500, Math.floor(1000 / gameState.debugSpeed))); // Main logic updates
            
            // Animation updates (faster, for smooth progress bars)
            setInterval(() => {
                // Update only the progress bars for extracting cells
                gameState.cells.forEach((cell, index) => {
                    if (cell.extractionStartTime && !cell.isReady) {
                        const cellElement = document.querySelector(`[data-index="${index}"]`);
                        if (cellElement) {
                            const progressOverlay = cellElement.querySelector('.progress-overlay');
                            if (progressOverlay) {
                                const totalTime = cell.extractionEndTime - cell.extractionStartTime;
                                const elapsed = Date.now() - cell.extractionStartTime;
                                const progress = Math.min(100, Math.max(0, (elapsed / totalTime) * 100));
                                
                                // Update progress height
                                progressOverlay.style.height = `${progress}%`;
                                
                                // Update near-completion effect
                                if (progress > 80) {
                                    progressOverlay.classList.add('near-completion');
                                } else {
                                    progressOverlay.classList.remove('near-completion');
                                }
                                
                                // Update timer text
                                const timer = cellElement.querySelector('.timer');
                                if (timer) {
                                    const remaining = Math.max(0, cell.extractionEndTime - Date.now());
                                    const totalMinutes = Math.floor(remaining / 60000);
                                    const seconds = Math.floor((remaining % 60000) / 1000);
                                    const timeStr = `${totalMinutes}:${seconds.toString().padStart(2, '0')}`;
                                    timer.textContent = timeStr;
                                    
                                    // Update tooltip
                                    cellElement.dataset.tooltip = `${cell.resourceType} - ${timeStr} remaining (${Math.round(progress)}%)`;
                                }
                            }
                        }
                    }
                });
            }, Math.max(100, Math.floor(500 / gameState.debugSpeed))); // Animation updates
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Save game state
        function saveGameState() {
            localStorage.setItem('farpostGame', JSON.stringify(gameState));
            
            // Also save to Farcaster if in frame context
            if (window.farcasterIntegration?.isAuthenticated()) {
                window.farcasterIntegration.saveGameState();
            }
        }

        // Load game state
        function loadGameState() {
            const saved = localStorage.getItem('farpostGame');
            if (saved) {
                const loadedState = JSON.parse(saved);
                // Merge with default state to handle new properties
                gameState = { ...gameState, ...loadedState };
                
                // Ensure expeditions and boosters are properly initialized
                if (!gameState.expeditions) {
                    gameState.expeditions = {
                        'Lunar Regolith': 0,
                        'Iron Ore': 0,
                        'Aluminum': 0,
                        'Water Ice': 0,
                        'Magnesium': 0,
                        'Silicon': 0,
                        'Titanium': 0,
                        'Rare Earth Elements': 0,
                        'Platinum Group Metals': 0,
                        'Helium-3': 0
                    };
                }
                
                if (!gameState.boosters) {
                    gameState.boosters = {
                        'Basic Booster': 0,
                        'Advanced Booster': 0,
                        'Elite Booster': 0,
                        'Master Booster': 0,
                        'Ultimate Booster': 0,
                        'Instant Extract': 0
                    };
                }
                
                // Set default mode and activeTab if missing
                gameState.mode = gameState.mode || 'select';
                gameState.activeTab = gameState.activeTab || 'buy';
                gameState.debugSpeed = gameState.debugSpeed || 1;
                
                // Initialize tutorial and achievements if missing
                if (!gameState.tutorial) {
                    gameState.tutorial = {
                        isActive: false,
                        step: 0,
                        completed: false,
                        initialSetup: false
                    };
                }
                
                if (!gameState.achievements) {
                    gameState.achievements = {
                        'first_expedition': { completed: false, title: 'First Expedition', description: 'Deploy your first expedition', reward: 100 },
                        'first_boost': { completed: false, title: 'Speed Demon', description: 'Use your first booster', reward: 50 },
                        'first_collect': { completed: false, title: 'Resource Collector', description: 'Collect your first resource', reward: 75 },
                        'first_sell': { completed: false, title: 'Merchant', description: 'Sell your first resource', reward: 100 },
                        'second_expedition': { completed: false, title: 'Expanding Operations', description: 'Buy a second expedition', reward: 150 },
                        'tutorial_complete': { completed: false, title: 'Graduate', description: 'Complete the tutorial', reward: 200 }
                    };
                }
                
                // Initialize Instant Extract booster if missing
                if (!gameState.boosters['Instant Extract']) {
                    gameState.boosters['Instant Extract'] = 0;
                }
                
                console.log('Game state loaded:', gameState);
            }
        }

        // Apply booster to specific cell
        function applyBoosterToCell(index) {
            if (gameState.boosters[gameState.selectedBooster] === 0) {
                showNotification(`No ${gameState.selectedBooster} in inventory!`, 'error');
                return;
            }
            
            const boosterConfig = gameConfig.boosters[gameState.selectedBooster];
            const cell = gameState.cells[index];
            
            // Only allow boosters on extracting cells
            if (!cell.extractionStartTime || cell.isReady) {
                showNotification('Can only apply booster to extracting cells!', 'error');
                return;
            }
            
            // Handle instant extract booster
            if (gameState.selectedBooster === 'Instant Extract') {
                // Instantly complete the extraction
                cell.extractionEndTime = Date.now();
                cell.isReady = true;
                
                // Use booster from inventory
                gameState.boosters[gameState.selectedBooster]--;
                
                // Reset mode and selection
                gameState.mode = 'select';
                gameState.selectedBooster = null;
                
                // Unlock achievement for first booster use
                if (!gameState.achievements.first_boost.completed) {
                    unlockAchievement('first_boost');
                }
                
                showNotification(`Instant Extract applied! Resource ready for collection!`, 'success');
                updateUI();
                saveGameState();
                
                // Check tutorial progress
                checkTutorialProgress();
                return;
            }
            
            // Check if cell already has a booster applied
            if (cell.boostMultiplier) {
                showNotification(`Cell already has ${cell.boosterName} applied!`, 'warning');
                return;
            }
            
            // Apply regular booster to this specific extracting cell
            const remaining = cell.extractionEndTime - Date.now();
            const newEndTime = Date.now() + Math.floor(remaining / boosterConfig.multiplier);
            cell.extractionEndTime = newEndTime;
            cell.boostMultiplier = boosterConfig.multiplier;
            cell.boosterAppliedTime = Date.now();
            cell.boosterName = gameState.selectedBooster;
            
            // Use booster from inventory
            gameState.boosters[gameState.selectedBooster]--;
            
            // Reset mode and selection
            gameState.mode = 'select';
            gameState.selectedBooster = null;
            
            // Check if extraction should be ready now
            if (Date.now() >= cell.extractionEndTime) {
                cell.isReady = true;
            }
            
            // Unlock achievement for first booster use
            if (!gameState.achievements.first_boost.completed) {
                unlockAchievement('first_boost');
            }
            
            showNotification(`${gameState.selectedBooster} applied! Extraction time reduced by ${boosterConfig.multiplier}x.`, 'success');
            updateUI();
            saveGameState();
            
            // Check tutorial progress
            checkTutorialProgress();
        }

        // Select booster for application
        function selectBooster(boosterName) {
            if (gameState.boosters[boosterName] === 0) {
                showNotification(`No ${boosterName} in inventory!`, 'error');
                return;
            }
            
            // Toggle selection if clicking the same booster
            if (gameState.selectedBooster === boosterName) {
                gameState.selectedBooster = null;
                gameState.mode = 'select';
                showNotification(`Deselected ${boosterName}.`, 'info');
            } else {
                gameState.selectedBooster = boosterName;
                gameState.selectedExpedition = null;
                gameState.mode = 'booster';
                showNotification(`Selected ${boosterName}. Click cells to apply booster!`, 'success');
            }
            
            // Check tutorial progress after selection
            checkTutorialProgress();
            
            updateUI();
        }

        // Purchase expedition
        function purchaseExpedition(resourceType) {
            const resourceConfig = gameConfig.resources[resourceType];
            
            // Check if resource is available at current level
            if (resourceConfig.level > gameState.level) {
                showNotification(`Level ${resourceConfig.level} required for ${resourceType}!`, 'error');
                return;
            }
            
            // Check if player has enough points
            if (gameState.points < resourceConfig.cost) {
                showNotification(`Not enough points! Need ${resourceConfig.cost} points for ${resourceType} expedition.`, 'error');
                return;
            }
            
            // Purchase expedition
            gameState.points -= resourceConfig.cost;
            gameState.expeditions[resourceType] = (gameState.expeditions[resourceType] || 0) + 1;
            
            showNotification(`Purchased ${resourceType} expedition! (Owned: ${gameState.expeditions[resourceType]})`, 'success');
            
            // Check second expedition achievement
            const totalExpeditions = Object.values(gameState.expeditions).reduce((sum, amount) => sum + amount, 0);
            if (totalExpeditions >= 2 && !gameState.achievements.second_expedition.completed) {
                unlockAchievement('second_expedition');
            }
            
            checkTutorialProgress();
            
            console.log('Expedition purchased:', resourceType, 'Total owned:', gameState.expeditions[resourceType]);
            updateUI();
            saveGameState();
        }

        // Select expedition for deployment
        function selectExpedition(resourceType) {
            if (gameState.expeditions[resourceType] === 0) {
                showNotification(`No ${resourceType} expeditions in inventory!`, 'error');
                return;
            }
            
            // Toggle selection if clicking the same resource
            if (gameState.selectedExpedition === resourceType) {
                gameState.selectedExpedition = null;
                gameState.mode = 'select';
                showNotification(`Deselected ${resourceType} expedition.`, 'info');
            } else {
                gameState.selectedExpedition = resourceType;
                gameState.selectedBooster = null;
                gameState.mode = 'deploy';
                showNotification(`Selected ${resourceType} expedition. Click cells to deploy!`, 'success');
            }
            
            // Check tutorial progress after selection
            checkTutorialProgress();
            
            updateUI();
        }

        // Purchase booster
        function purchaseBooster(boosterName) {
            const boosterConfig = gameConfig.boosters[boosterName];
            
            // Instant Extract boosters cannot be purchased
            if (boosterName === 'Instant Extract') {
                showNotification('Instant Extract boosters cannot be purchased!', 'error');
                return;
            }
            
            if (gameState.level < boosterConfig.level) {
                showNotification(`Level ${boosterConfig.level} required for ${boosterName}!`, 'error');
                return;
            }
            
            if (gameState.points < boosterConfig.cost) {
                showNotification(`Not enough points! Need ${boosterConfig.cost} points for ${boosterName}.`, 'error');
                return;
            }
            
            // Purchase booster
            gameState.points -= boosterConfig.cost;
            gameState.boosters[boosterName] = (gameState.boosters[boosterName] || 0) + 1;
            
            showNotification(`Purchased ${boosterName}! (Owned: ${gameState.boosters[boosterName]})`, 'success');
            console.log('Booster purchased:', boosterName, 'Total owned:', gameState.boosters[boosterName]);
            updateUI();
            saveGameState();
        }

        // Debug functions
        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
        }

        function resetTutorial() {
            if (confirm('Are you sure you want to restart the tutorial? This will reset your tutorial progress.')) {
                // Clear any active tutorial state
                clearTutorialHighlights();
                unblockAllElements();
                hideTutorialModal(true); // Skip progress check
                
                // Reset tutorial state
                gameState.tutorial = {
                    isActive: false,
                    step: 0,
                    completed: false,
                    initialSetup: false
                };
                
                // Reset tutorial achievement
                gameState.achievements.tutorial_complete.completed = false;
                
                // Setup tutorial from beginning
                setupTutorial();
                
                showNotification('Tutorial reset! Starting from the beginning.', 'success');
                saveGameState();
            }
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset all game progress? This cannot be undone!')) {
                // Clear local storage
                localStorage.removeItem('farpostGame');
                
                // Reset game state to default
                gameState = {
                    level: 1,
                    xp: 0,
                    points: 1000,
                    ownedCells: 3,
                    maxCells: 3,
                    selectedExpedition: null,
                    selectedBooster: null,
                    resources: {
                        'Lunar Regolith': 0,
                        'Iron Ore': 0,
                        'Aluminum': 0,
                        'Water Ice': 0,
                        'Magnesium': 0,
                        'Silicon': 0,
                        'Titanium': 0,
                        'Rare Earth Elements': 0,
                        'Platinum Group Metals': 0,
                        'Helium-3': 0
                    },
                    expeditions: {
                        'Lunar Regolith': 0,
                        'Iron Ore': 0,
                        'Aluminum': 0,
                        'Water Ice': 0,
                        'Magnesium': 0,
                        'Silicon': 0,
                        'Titanium': 0,
                        'Rare Earth Elements': 0,
                        'Platinum Group Metals': 0,
                        'Helium-3': 0
                    },
                    boosters: {
                        'Basic Booster': 0,
                        'Advanced Booster': 0,
                        'Elite Booster': 0,
                        'Master Booster': 0,
                        'Ultimate Booster': 0,
                        'Instant Extract': 0
                    },
                    cells: Array(18).fill(null).map((_, index) => ({
                        id: index,
                        owned: [7, 8, 9].includes(index), // Middle cells owned by default
                        resourceType: null,
                        extractionStartTime: null,
                        extractionEndTime: null,
                        isReady: false
                    })),
                    activeTab: 'buy',
                    mode: 'select',
                    debugSpeed: 1,
                    tutorial: {
                        isActive: false,
                        step: 0,
                        completed: false,
                        initialSetup: false
                    },
                    achievements: {
                        'first_expedition': { completed: false, title: 'First Expedition', description: 'Deploy your first expedition', reward: 100 },
                        'first_boost': { completed: false, title: 'Speed Demon', description: 'Use your first booster', reward: 50 },
                        'first_collect': { completed: false, title: 'Resource Collector', description: 'Collect your first resource', reward: 75 },
                        'first_sell': { completed: false, title: 'Merchant', description: 'Sell your first resource', reward: 100 },
                        'second_expedition': { completed: false, title: 'Expanding Operations', description: 'Buy a second expedition', reward: 150 },
                        'tutorial_complete': { completed: false, title: 'Graduate', description: 'Complete the tutorial', reward: 200 }
                    }
                };
                
                // Regenerate grid and update UI
                generateGrid();
                updateUI();
                saveGameState();
                
                showNotification('Game reset successfully!', 'success');
            }
        }

        function updateDebugSpeed() {
            const slider = document.getElementById('speedSlider');
            const display = document.getElementById('speedDisplay');
            const oldSpeed = gameState.debugSpeed;
            gameState.debugSpeed = parseInt(slider.value);
            display.textContent = `${gameState.debugSpeed}x`;
            
            // Recalculate ongoing extractions with new speed
            if (oldSpeed !== gameState.debugSpeed) {
                gameState.cells.forEach(cell => {
                    if (cell.extractionStartTime && !cell.isReady) {
                        const elapsed = Date.now() - cell.extractionStartTime;
                        const originalDuration = cell.extractionEndTime - cell.extractionStartTime;
                        
                        // Calculate what the original duration should have been without old speed
                        const baseOriginalDuration = originalDuration * oldSpeed;
                        
                        // Apply new speed to the base duration
                        const newDuration = Math.floor(baseOriginalDuration / gameState.debugSpeed);
                        
                        // Set new end time
                        cell.extractionEndTime = cell.extractionStartTime + newDuration;
                        
                        // If the extraction should have already finished, mark as ready
                        if (Date.now() >= cell.extractionEndTime) {
                            cell.isReady = true;
                        }
                    }
                });
                updateUI();
            }
            
            saveGameState();
        }

        // Keyboard shortcut for debug panel
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDebug();
            }
        });

        // Update user display
        function updateUserDisplay(user) {
            const userDisplay = document.getElementById('userDisplay');
            const shareBtn = document.getElementById('shareBtn');
            if (!userDisplay) return;
            
            if (user) {
                if (user.isFrameUser || user.isMiniAppUser) {
                    userDisplay.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 5px;">
                            ${user.pfpUrl ? `<img src="${user.pfpUrl}" alt="${user.username}" style="width: 16px; height: 16px; border-radius: 50%;">` : '🎯'}
                            <span>@${user.username || `fid:${user.fid}`}</span>
                            ${user.isMiniAppUser ? '<span style="color: #1DA1F2; font-size: 10px;">📱 Mini App</span>' : ''}
                        </div>
                    `;
                    
                    // Show share button for Mini App users
                    if (user.isMiniAppUser && shareBtn) {
                        shareBtn.style.display = 'inline-block';
                    }
                } else {
                    userDisplay.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 5px;">
                            👤 <span>${user.email || user.username || 'Player'}</span>
                        </div>
                    `;
                }
            } else {
                userDisplay.innerHTML = '';
                if (shareBtn) {
                    shareBtn.style.display = 'none';
                }
            }
        }

        // Share progress via Mini App
        async function shareProgress() {
            if (!window.farcasterIntegration?.isMiniApp) {
                showNotification('Sharing is only available in Mini App mode', 'warning');
                return;
            }

            const level = gameState.level;
            const points = gameState.points.toLocaleString();
            const ownedCells = gameState.ownedCells;
            const completedAchievements = Object.values(gameState.achievements).filter(a => a.completed).length;
            const totalAchievements = Object.keys(gameState.achievements).length;

            const message = `🌙 Just reached Level ${level} in Farpost! 
🏆 ${completedAchievements}/${totalAchievements} achievements unlocked
💰 ${points} points earned
🌍 ${ownedCells} lunar cells owned

Mining the Moon, one resource at a time! 🚀

Play: https://farpost.lunco.space/`;

            const success = await window.farcasterIntegration.shareGameState(message);
            
            if (success) {
                showNotification('Progress shared successfully! 🎉', 'success');
            } else {
                showNotification('Failed to share progress', 'error');
            }
        }

        // Send achievement notification via Mini App
        async function sendAchievementNotification(achievementTitle) {
            if (!window.farcasterIntegration?.isMiniApp) {
                return;
            }

            await window.farcasterIntegration.sendNotification(
                '🏆 Achievement Unlocked!',
                `You've earned: ${achievementTitle}`,
                window.location.href
            );
        }

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html> 